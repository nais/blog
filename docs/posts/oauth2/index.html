<!DOCTYPE html>
<html><head>
   <meta charset="UTF-8">
   <meta lang="en">
   <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1" />
   <meta http-equiv="Content-Security-Policy" content="font-src https://fonts.googleapis.com https://fonts.gstatic.com; connect-src 'self' https://fonts.googleapis.com https://amplitude.nav.no">
   <link rel="apple-touch-icon" sizes="180x180" href="/blog/images/apple-touch-icon.png" />
   <link rel="icon" type="image/png" sizes="32x32" href="/blog/images/favicon-32x32.png" />
   <link rel="icon" type="image/png" sizes="16x16" href="/blog/images/favicon-16x16.png" />
   <link rel="mask-icon" href="/blog/images/safari-pinned-tab.svg" color="#66cbec" />
   <link rel="preconnect" href="https://fonts.googleapis.com">
   <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
   <link href="https://fonts.googleapis.com/css2?family=Noto+Serif:ital,wght@0,400;0,700;1,400;1,700&display=swap"
      rel="stylesheet">
   <link rel="stylesheet" href="/blog/style.css">
   <title>nais blog</title>

   <script type="text/javascript" src="/blog/amplitude.js"></script><meta property="og:title" content="OAuth del 2 (Token Exchange)">
<meta property="og:description" content="OAuth for dummies, del 2 (token exchange)">
<meta property="og:type" content="article">

<meta property="og:url" content="https://nais.io/blog/posts/oauth2/">
<meta property="og:locale" content="no-NO">




    <meta property="og:image" content="https://nais.io/blog/images/oauth2.png">

    <meta property="og:image" content="https://nais.io/blog/images/exchange.png">
<meta property="article:published_time" content="2020-09-16T08:10:01+02:00">
<meta property="article:modified_time" content="2020-09-16T08:10:01+02:00">
<meta property="og:updated_time" content="2020-09-16T08:10:01+02:00">


<meta property="article:tag" content="oauth">
<meta property="article:tag" content="oidc">
<meta property="article:tag" content="sikkerhet">

</head>
<body><header>
    <div>
        <a href="https://nais.io/blog">
            <img alt="The NAIS logo: a hand forming an OK symbol, shaped like a pipe wrench, in rainbow colors" src="/blog/images/logo.png">
            <h1>nais blog</h1>
        </a>
    </div>
</header>
<main>
            <article>
                <h1>OAuth del 2 (Token Exchange)</h1>

                <em>OAuth for dummies, del 2 (token exchange)</em>

                <section class="meta">
                    <p>
                    Published
                    <time datetime="2020-09-16T08:10:01&#43;02:00">Sep 16, 2020</time>
                    by Jan-Kåre Solbakken
                    </p>
										
                    <nav class="tags">
                        <ul>
                            
                            
                            <li><a href="https://nais.io/blog/tags/oauth">#oauth</a></li>
                            
                            <li><a href="https://nais.io/blog/tags/oidc">#oidc</a></li>
                            
                            <li><a href="https://nais.io/blog/tags/sikkerhet">#sikkerhet</a></li>
                            
                        </ul>
                    </nav>
										
                </section>

                <p><img src="/blog/images/oauth2.png" alt="OAuth2"></p>
<h2 id="bakgrunn">Bakgrunn</h2>
<p>I NAV er <a href="/blog/posts/oauth1">OAuth og OIDC</a> de facto standard for å løse autentisering og autorisering i appene våre. I en løst koblet verden med mikrotjenester og <a href="https://doc.nais.io/appendix/zero-trust">zero trust</a> er det imidlertid flere brikker som må på plass. Hvordan kan man på en trygg måte kalle andre tjenester videre bakover i kjeden og samtidig bevare sluttbrukerkonteksten? Tidligere har man benyttet såkalte &ldquo;systembrukere&rdquo;, dvs brukere som identifiserer systemet/tjenesten som det kalles fra. Man har hatt en eller flere <a href="https://en.wikipedia.org/wiki/Security_token_service">Security Token Services</a> som har vekslet systembrukerens brukernavn og passord inn i et access token som benyttes for videre kall. Dette har flere ulemper. Systembrukerene må ha ganske romslige rettigheter (som gjør det ekstra viktig at de ikke blir kompromittert), og informasjon om sluttbrukeren som initierte kallet blir borte med mindre man legger på hjemmesnekra hacks.</p>
<h2 id="token-exchange-standarden">Token Exchange standarden</h2>
<p><a href="https://www.rfc-editor.org/rfc/rfc8693.html">RFC 8693 - OAuth 2.0 Token Exchange</a> adresserer akkurat dette problemet, og har nå endelig blitt en &ldquo;proposed standard&rdquo;. Azure AD (som vi bruker som ID-provider for egne ansatte) har lenge tilbydd en <a href="https://docs.microsoft.com/en-us/azure/active-directory/develop/v2-oauth2-on-behalf-of-flow">on-behalf-of flyt</a> som er veldig lik den nye standarden, men for borgerne som logger på med ID-porten har vi ikke hatt noe tilsvarende.</p>
<h3 id="flyten">Flyten</h3>
<p><img src="/blog/images/exchange.png" alt="token exchange flow"></p>
<ul>
<li>Sluttbruker logger inn hos ID-provider.</li>
<li>ID-provider returnerer et access token med audience <code>API 1</code>.</li>
<li>API 1 ber om å veksle tokenet fra ID-provider med et nytt access token for API 2 fra exchangeren</li>
<li>Exchangeren validerer requesten og tokenet som skal veksles, sjekker om <code>API 1</code> er forhåndsgodkjent til å kalle <code>API 2</code> og returnerer et nytt access token beregnet på <code>API 2</code> med audience lik  <code>API 2</code>.</li>
<li><code>API 1</code> ber om data fra <code>API 2</code> på vegne av sluttbruker vha det nye access tokenet.</li>
<li><code>API 2</code> validerer access tokenet og returnerer de forespurte dataene.</li>
</ul>
<p>Token exchange-forespørselen kan se ut som følger:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>POST /token HTTP/1.1
</span></span><span style="display:flex;"><span>Host: tokenxchange-server
</span></span><span style="display:flex;"><span>Content-Type: application/x-www-form-urlencoded
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">grant_type</span><span style="color:#ff79c6">=</span>urn:ietf:params:oauth:grant-type:token-exchange&amp;
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">client_assertion_type</span><span style="color:#ff79c6">=</span>urn:ietf:params:oauth:client-assertion-type:jwt-bearer&amp;
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">client_assertion</span><span style="color:#ff79c6">=</span>eY...............&amp;
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">subject_token_type</span><span style="color:#ff79c6">=</span>urn:ietf:params:oauth:token-type:jwt&amp;
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">subject_token</span><span style="color:#ff79c6">=</span>eY...............&amp;
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">audience</span><span style="color:#ff79c6">=</span>app1
</span></span></code></pre></div><p><code>grant_type</code> er en fast verdi som er definert av standarden.</p>
<p><code>subject_token</code> inneholder tokenet som skal veksles og identifiserer sluttbrukeren (tokenet hen fikk fra id-provideren).</p>
<p><code>audience</code> inneholder identifikatoren til appen som skal motta tokenet du nå ber om</p>
<p><code>client_assertion</code> identifiserer appen mot exhangeren (i dette eksemplet <code>App 1</code>). En client_assertion er en Base 64-kodet JWT som appen genererer og signerer vha sin private nøkkel. JWT-en inneholder følgende claims:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#f1fa8c">&#39;sub&#39;</span><span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">`api1`</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f1fa8c">&#39;aud&#39;</span><span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#39;http://tokenxchange-server/token&#39;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f1fa8c">&#39;iss&#39;</span><span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#39;api1&#39;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f1fa8c">&#39;exp&#39;</span><span style="color:#ff79c6">:</span> <span style="color:#bd93f9">1516239052</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f1fa8c">&#39;iat&#39;</span><span style="color:#ff79c6">:</span> <span style="color:#bd93f9">1516239022</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f1fa8c">&#39;jti&#39;</span><span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#39;a_unique_id&#39;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f1fa8c">&#39;nbf&#39;</span><span style="color:#ff79c6">:</span> <span style="color:#bd93f9">1516239022</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="token-exchange-i-nav">Token Exchange i NAV</h2>
<p>Token Exchange-standarden er fortsatt fersk, og det er i skrivende stund ingen av de kommersielle leverandørene som har implementert den. Vi har derfor valgt å lage vår egen løsning som vi har kalt <a href="https://doc.nais.io/addons/tokenx">TokenX</a>. Den mest sentrale komponenten i TokenX er <a href="https://github.com/nais/tokendings">Tokendings</a>. Den er en OAuth 2.0 Authorization Server med funksjonalitet som en STS, men vi har valgt å ikke bruke den beskrivelsen fordi STS er et reservert ord i NAV. Provisjonering av nøkler som appene bruker til signering av assertions skjer automatisk ved deploy vha operatorer (<a href="https://github.com/nais/jwker/">Jwker</a> og <a href="https://github.com/nais/naiserator/">Naiserator</a>) i k8s clusteret, og tilgjengeliggjøres som miljøvariabler i podene. Hvilke apper som skal få lov til å snakke sammen utledes automatisk ut fra Istio access policyene som appene uansett må sette opp for å fungere. Nøklene roteres ved hver deploy.</p>


            </article>
        </main><footer>
    <a href="https://nais.io">nais</a> &copy; 2020
</footer>
</body>
</html>
